<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è¯‰åé¦ˆæ¥å£è°ƒè¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .config-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .config-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .config-item {
            flex: 1;
            min-width: 200px;
        }

        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .config-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .api-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .api-card:hover {
            transform: translateY(-5px);
        }

        .api-card.disabled {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .api-card.disabled::after {
            content: 'è¯·å…ˆç™»å½•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
        }

        .api-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .method {
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .method.get { background: #61affe; color: white; }
        .method.post { background: #49cc90; color: white; }
        .method.put { background: #fca130; color: white; }

        .path {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .result.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-code {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-code.success { background: #d4edda; color: #155724; }
        .status-code.error { background: #f8d7da; color: #721c24; }

        .result-body {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .section-title {
            color: white;
            font-size: 1.5em;
            margin: 30px 0 15px 0;
            padding-left: 10px;
            border-left: 4px solid white;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ç™»å½•çŠ¶æ€æ  */
        .login-status {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .login-status.logged-in {
            border-left: 5px solid #38ef7d;
        }

        .login-status.logged-out {
            border-left: 5px solid #f5576c;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background: #38ef7d;
            box-shadow: 0 0 10px #38ef7d;
        }

        .status-dot.offline {
            background: #f5576c;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .token-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .login-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }

        .login-form .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 150px;
        }

        .login-form .btn {
            width: auto;
            padding: 10px 30px;
        }

        .logout-btn {
            background: #dc3545;
            padding: 8px 20px;
            width: auto;
        }

        .section-locked {
            position: relative;
        }

        .section-locked::before {
            content: 'ğŸ”’ è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨ä»¥ä¸‹æ¥å£';
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(245, 87, 108, 0.9);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ æŠ•è¯‰åé¦ˆæ¥å£è°ƒè¯•å·¥å…·</h1>

        <!-- å…¨å±€é…ç½® -->
        <div class="config-panel">
            <h3 style="margin-bottom: 15px; color: #333;">âš™ï¸ å…¨å±€é…ç½®</h3>
            <div class="config-row">
                <div class="config-item">
                    <label>Base URL</label>
                    <input type="text" id="baseUrl" value="http://localhost:5000" placeholder="http://localhost:5000">
                </div>
            </div>
        </div>

        <!-- ç™»å½•çŠ¶æ€æ  -->
        <div id="loginStatusPanel" class="login-status logged-out">
            <div class="status-info">
                <span class="status-dot offline" id="statusDot"></span>
                <div>
                    <div style="font-weight: 600; margin-bottom: 5px;" id="statusText">æœªç™»å½•</div>
                    <div class="token-display" id="tokenDisplay" style="display: none;">Token: </div>
                </div>
                <span class="user-badge" id="userBadge" style="display: none;">User: <span id="userIdDisplay"></span></span>
            </div>

            <div id="loginFormContainer">
                <div class="login-form">
                    <div class="form-group">
                        <label>æ‰‹æœºå·</label>
                        <input type="text" id="loginMobile" placeholder="13800138000" value="">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="loginPassword" placeholder="password" value="">
                    </div>
                    <button class="btn success" onclick="handleLogin()">
                        ç™»å½•
                    </button>
                </div>
            </div>

            <div id="logoutContainer" style="display: none;">
                <button class="btn warning logout-btn" onclick="handleLogout()">
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>

        <!-- å¿«æ·æ“ä½œ -->
        <div class="quick-actions">
            <button class="quick-btn" onclick="fillTestData()">ğŸ“ å¡«å……æµ‹è¯•æ•°æ®</button>
            <button class="quick-btn" onclick="clearAllResults()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰ç»“æœ</button>
        </div>

        <!-- å…¬å¼€æ¥å£ -->
        <div class="section-title">ğŸŒ å…¬å¼€æ¥å£</div>
        <div class="grid">
            <!-- è·å–æŠ•è¯‰ç±»å‹ -->
            <div class="api-card">
                <div class="api-header">
                    <span class="method get">GET</span>
                    <span class="path">/api/complaint/types</span>
                </div>
                <button class="btn" onclick="testGetTypes()">
                    è·å–æŠ•è¯‰ç±»å‹åˆ—è¡¨
                </button>
                <div class="result" id="result-types"></div>
            </div>

            <!-- ç”¨æˆ·ç™»å½• -->
            <div class="api-card">
                <div class="api-header">
                    <span class="method post">POST</span>
                    <span class="path">/api/user/login</span>
                </div>
                <div class="form-group">
                    <label>æ‰‹æœºå· *</label>
                    <input type="text" id="test-mobile" placeholder="13800138000">
                </div>
                <div class="form-group">
                    <label>å¯†ç  *</label>
                    <input type="password" id="test-password" placeholder="password">
                </div>
                <div class="form-group">
                    <label>è®¾å¤‡å‹å· (Header)</label>
                    <input type="text" id="test-device-model" value="WebBrowser" placeholder="WebBrowser">
                </div>
                <div class="form-group">
                    <label>è®¾å¤‡ç±»å‹ (Header)</label>
                    <input type="text" id="test-device-type" value="2" placeholder="2">
                </div>
                <button class="btn secondary" onclick="testLogin()">
                    æµ‹è¯•ç™»å½•æ¥å£
                </button>
                <div class="result" id="result-login"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰ -->
        <div class="section-title" id="userSectionTitle">ğŸ‘¤ ç”¨æˆ·æ¥å£</div>
        <div class="grid" id="userSection">
            <!-- è·å–æˆ‘çš„åé¦ˆåˆ—è¡¨ -->
            <div class="api-card" data-requires-auth="true">
                <div class="api-header">
                    <span class="method get">GET</span>
                    <span class="path">/api/feedback/list</span>
                </div>
                <div class="form-group">
                    <label>è§£å†³çŠ¶æ€ (is_resolved)</label>
                    <select id="list-resolved">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">æœªè§£å†³</option>
                        <option value="1">å·²è§£å†³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡µç  (page)</label>
                    <input type="number" id="list-page" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>æ¯é¡µæ•°é‡ (limit)</label>
                    <input type="number" id="list-limit" value="20" min="1" max="100">
                </div>
                <button class="btn" onclick="testGetMyList()">
                    è·å–æˆ‘çš„åé¦ˆåˆ—è¡¨
                </button>
                <div class="result" id="result-mylist"></div>
            </div>

            <!-- è·å–åé¦ˆè¯¦æƒ… -->
            <div class="api-card" data-requires-auth="true">
                <div class="api-header">
                    <span class="method get">GET</span>
                    <span class="path">/api/feedback/detail/{id}</span>
                </div>
                <div class="form-group">
                    <label>åé¦ˆID</label>
                    <input type="number" id="detail-id" placeholder="è¾“å…¥åé¦ˆID">
                </div>
                <button class="btn" onclick="testGetDetail()">
                    æŸ¥çœ‹åé¦ˆè¯¦æƒ…
                </button>
                <div class="result" id="result-detail"></div>
            </div>

            <!-- æäº¤åé¦ˆ -->
            <div class="api-card" data-requires-auth="true">
                <div class="api-header">
                    <span class="method post">POST</span>
                    <span class="path">/api/feedback/submit</span>
                </div>
                <div class="form-group">
                    <label>æŠ•è¯‰ç±»å‹ *</label>
                    <select id="submit-type">
                        <option value="1">1-åŠŸèƒ½</option>
                        <option value="2" selected>2-BUG</option>
                        <option value="3">3-å»ºè®®</option>
                        <option value="4">4-å…¶ä»–</option>
                        <option value="5">5-éšç§å®‰å…¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æè¿°å†…å®¹ *</label>
                    <textarea id="submit-desc" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜..."></textarea>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡URL 1</label>
                    <input type="text" id="submit-img1" placeholder="http://example.com/img1.jpg">
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡URL 2</label>
                    <input type="text" id="submit-img2" placeholder="http://example.com/img2.jpg">
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡URL 3</label>
                    <input type="text" id="submit-img3" placeholder="http://example.com/img3.jpg">
                </div>
                <div class="form-group">
                    <label>ä¼˜å…ˆçº§</label>
                    <select id="submit-priority">
                        <option value="1">1-ä½</option>
                        <option value="2">2-ä¸­</option>
                        <option value="3" selected>3-é«˜</option>
                    </select>
                </div>
                <button class="btn" onclick="testSubmit()">
                    æäº¤åé¦ˆ
                </button>
                <div class="result" id="result-submit"></div>
            </div>

            <!-- æ›´æ–°åé¦ˆ -->
            <div class="api-card" data-requires-auth="true">
                <div class="api-header">
                    <span class="method put">PUT</span>
                    <span class="path">/api/feedback/update/{id}</span>
                </div>
                <div class="form-group">
                    <label>åé¦ˆID *</label>
                    <input type="number" id="update-id" placeholder="è¾“å…¥åé¦ˆID">
                </div>
                <div class="form-group">
                    <label>æ–°æè¿°å†…å®¹</label>
                    <textarea id="update-desc" placeholder="æ›´æ–°æè¿°..."></textarea>
                </div>
                <div class="form-group">
                    <label>æ–°ä¼˜å…ˆçº§</label>
                    <select id="update-priority">
                        <option value="">ä¸ä¿®æ”¹</option>
                        <option value="1">1-ä½</option>
                        <option value="2">2-ä¸­</option>
                        <option value="3">3-é«˜</option>
                    </select>
                </div>
                <button class="btn" onclick="testUpdate()">
                    æ›´æ–°åé¦ˆ
                </button>
                <div class="result" id="result-update"></div>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜æ¥å£ -->
        <div class="section-title">ğŸ”§ ç®¡ç†å‘˜æ¥å£</div>
        <div class="grid">
            <!-- ç®¡ç†å‘˜è·å–åˆ—è¡¨ -->
            <div class="api-card">
                <div class="api-header">
                    <span class="method get">GET</span>
                    <span class="path">/api/admin/feedback/list</span>
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·ID (ç­›é€‰)</label>
                    <input type="number" id="admin-list-userid" placeholder="å¯é€‰">
                </div>
                <div class="form-group">
                    <label>æŠ•è¯‰ç±»å‹ (ç­›é€‰)</label>
                    <select id="admin-list-type">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">1-åŠŸèƒ½</option>
                        <option value="2">2-BUG</option>
                        <option value="3">3-å»ºè®®</option>
                        <option value="4">4-å…¶ä»–</option>
                        <option value="5">5-éšç§å®‰å…¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è§£å†³çŠ¶æ€</label>
                    <select id="admin-list-resolved">
                        <option value="">å…¨éƒ¨</option>
                        <option value="0">æœªè§£å†³</option>
                        <option value="1">å·²è§£å†³</option>
                    </select>
                </div>
                <button class="btn secondary" onclick="testAdminList()">
                    è·å–å…¨éƒ¨åé¦ˆåˆ—è¡¨
                </button>
                <div class="result" id="result-adminlist"></div>
            </div>

            <!-- ç®¡ç†å‘˜æŸ¥çœ‹è¯¦æƒ… -->
            <div class="api-card">
                <div class="api-header">
                    <span class="method get">GET</span>
                    <span class="path">/api/admin/feedback/detail/{id}</span>
                </div>
                <div class="form-group">
                    <label>åé¦ˆID</label>
                    <input type="number" id="admin-detail-id" placeholder="è¾“å…¥åé¦ˆID">
                </div>
                <button class="btn secondary" onclick="testAdminDetail()">
                    æŸ¥çœ‹åé¦ˆè¯¦æƒ…
                </button>
                <div class="result" id="result-admindetail"></div>
            </div>

            <!-- ç®¡ç†å‘˜è§£å†³åé¦ˆ -->
            <div class="api-card">
                <div class="api-header">
                    <span class="method post">POST</span>
                    <span class="path">/api/admin/feedback/resolve/{id}</span>
                </div>
                <div class="form-group">
                    <label>åé¦ˆID *</label>
                    <input type="number" id="resolve-id" placeholder="è¾“å…¥åé¦ˆID">
                </div>
                <div class="form-group">
                    <label>å›å¤å†…å®¹ *</label>
                    <textarea id="resolve-content" placeholder="è¯·è¾“å…¥å¤„ç†ç»“æœå’Œå›å¤å†…å®¹..."></textarea>
                </div>
                <button class="btn secondary" onclick="testResolve()">
                    è§£å†³å¹¶å›å¤åé¦ˆ
                </button>
                <div class="result" id="result-resolve"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let authState = {
            isLoggedIn: false,
            token: null,
            userId: null,
            userInfo: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
            const savedAuth = localStorage.getItem('debug_auth');
            if (savedAuth) {
                const auth = JSON.parse(savedAuth);
                // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼ˆç®€å•åˆ¤æ–­ï¼‰
                if (auth.token) {
                    restoreLoginState(auth);
                }
            }
            updateUI();
        });

        // ä¿å­˜ç™»å½•çŠ¶æ€
        function saveAuthState() {
            localStorage.setItem('debug_auth', JSON.stringify(authState));
        }

        // æ¢å¤ç™»å½•çŠ¶æ€
        function restoreLoginState(auth) {
            authState = auth;
        }

        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            const panel = document.getElementById('loginStatusPanel');
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const tokenDisplay = document.getElementById('tokenDisplay');
            const userBadge = document.getElementById('userBadge');
            const userIdDisplay = document.getElementById('userIdDisplay');
            const loginForm = document.getElementById('loginFormContainer');
            const logoutContainer = document.getElementById('logoutContainer');
            const userSection = document.getElementById('userSection');
            const userSectionTitle = document.getElementById('userSectionTitle');

            if (authState.isLoggedIn) {
                // å·²ç™»å½•çŠ¶æ€
                panel.className = 'login-status logged-in';
                dot.className = 'status-dot online';
                statusText.textContent = `å·²ç™»å½•: ${authState.userInfo?.real_name || authState.userInfo?.mobile || 'Unknown'}`;
                tokenDisplay.style.display = 'block';
                tokenDisplay.textContent = `Token: ${authState.token.substring(0, 20)}...`;
                userBadge.style.display = 'inline-block';
                userIdDisplay.textContent = authState.userId;
                loginForm.style.display = 'none';
                logoutContainer.style.display = 'block';

                // è§£é”ç”¨æˆ·æ¥å£åŒºåŸŸ
                userSectionTitle.classList.remove('section-locked');
                document.querySelectorAll('[data-requires-auth="true"]').forEach(card => {
                    card.classList.remove('disabled');
                });
            } else {
                // æœªç™»å½•çŠ¶æ€
                panel.className = 'login-status logged-out';
                dot.className = 'status-dot offline';
                statusText.textContent = 'æœªç™»å½•';
                tokenDisplay.style.display = 'none';
                userBadge.style.display = 'none';
                loginForm.style.display = 'block';
                logoutContainer.style.display = 'none';

                // é”å®šç”¨æˆ·æ¥å£åŒºåŸŸ
                userSectionTitle.classList.add('section-locked');
                document.querySelectorAll('[data-requires-auth="true"]').forEach(card => {
                    card.classList.add('disabled');
                });
            }
        }

        // è·å–é…ç½®
        function getConfig() {
            return {
                baseUrl: document.getElementById('baseUrl').value.trim() || 'http://localhost:5000'
            };
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, response, isError = false) {
            const el = document.getElementById(elementId);
            const statusClass = isError ? 'error' : 'success';
            const statusText = isError ? 'ERROR' : 'SUCCESS';

            el.innerHTML = `
                <div class="result-header">
                    <span>è¯·æ±‚ç»“æœ</span>
                    <span class="status-code ${statusClass}">${statusText}</span>
                </div>
                <div class="result-body">${syntaxHighlight(JSON.stringify(response, null, 2))}</div>
            `;
            el.classList.add('show');
        }

        // JSONè¯­æ³•é«˜äº®
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                        match = match.slice(0, -1) + '</span>:';
                        return `<span style="color: #f92672;">${match}</span>`;
                    } else {
                        cls = 'string';
                        return `<span style="color: #e6db74;">${match}</span>`;
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                    return `<span style="color: #ae81ff;">${match}</span>`;
                } else if (/null/.test(match)) {
                    cls = 'null';
                    return `<span style="color: #66d9ef;">${match}</span>`;
                }
                return `<span style="color: #ae81ff;">${match}</span>`;
            });
        }

        // å‘é€è¯·æ±‚å°è£…
        async function sendRequest(url, options = {}) {
            const config = getConfig();
            const fullUrl = config.baseUrl + url;

            // è®¾ç½®é»˜è®¤headers
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            // å¦‚æœæœ‰tokenï¼Œæ·»åŠ åˆ°headerï¼ˆä½¿ç”¨Authorization Beareræ ¼å¼ï¼‰
            if (authState.token && options.useAuth !== false) {
                headers['Authorization'] = `Bearer ${authState.token}`;
            }

            try {
                const response = await fetch(fullUrl, {
                    ...options,
                    headers: headers
                });
                const data = await response.json();
                return {
                    status: response.status,
                    data: data,
                    ok: response.ok
                };
            } catch (error) {
                return {
                    status: 0,
                    data: { code: 0, message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message, data: null },
                    ok: false
                };
            }
        }

        // ç™»å½•å¤„ç†
        async function handleLogin() {
            const mobile = document.getElementById('loginMobile').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!mobile || !password) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
                return;
            }

            await performLogin(mobile, password, 'WebDebugger', '2');
        }

        // æ‰§è¡Œç™»å½•
        async function performLogin(mobile, password, deviceModel, deviceType) {
            const btn = event ? event.target : document.querySelector('#loginFormContainer .btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ç™»å½•ä¸­<span class="loading"></span>';

            const result = await sendRequest('/api/user/login', {
                method: 'POST',
                body: JSON.stringify({
                    mobile: mobile,
                    password: password
                }),
                headers: {
                    'X-Device-Model': deviceModel,
                    'X-Device-Type': deviceType
                },
                useAuth: false // ç™»å½•æ¥å£ä¸éœ€è¦token
            });

            if (result.ok && result.data.code === 200) {
                // ç™»å½•æˆåŠŸ
                authState.isLoggedIn = true;
                authState.token = result.data.data.token;
                authState.userId = result.data.data.user_info.user_id;
                authState.userInfo = result.data.data.user_info;

                saveAuthState();
                updateUI();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert(`ç™»å½•æˆåŠŸï¼æ¬¢è¿, ${authState.userInfo.real_name || authState.userInfo.mobile}`);
            } else {
                alert('ç™»å½•å¤±è´¥: ' + (result.data.message || 'æœªçŸ¥é”™è¯¯'));
            }

            btn.innerHTML = originalText;
            return result;
        }

        // é€€å‡ºç™»å½•
        function handleLogout() {
            authState = {
                isLoggedIn: false,
                token: null,
                userId: null,
                userInfo: null
            };
            localStorage.removeItem('debug_auth');
            updateUI();
            clearAllResults();
        }

        // ============== å…¬å¼€æ¥å£ ==============
        async function testGetTypes() {
            const btn = event.target;
            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';

            const result = await sendRequest('/api/complaint/types', { useAuth: false });
            showResult('result-types', result.data, !result.ok);

            btn.innerHTML = 'è·å–æŠ•è¯‰ç±»å‹åˆ—è¡¨';
        }

        async function testLogin() {
            const btn = event.target;
            const mobile = document.getElementById('test-mobile').value.trim();
            const password = document.getElementById('test-password').value;
            const deviceModel = document.getElementById('test-device-model').value;
            const deviceType = document.getElementById('test-device-type').value;

            if (!mobile || !password) {
                alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
                return;
            }

            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';

            const result = await sendRequest('/api/user/login', {
                method: 'POST',
                body: JSON.stringify({
                    mobile: mobile,
                    password: password
                }),
                headers: {
                    'X-Device-Model': deviceModel,
                    'X-Device-Type': deviceType
                },
                useAuth: false
            });

            showResult('result-login', result.data, !result.ok);

            // å¦‚æœç™»å½•æˆåŠŸï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜ç™»å½•çŠ¶æ€
            if (result.ok && result.data.code === 200 && !authState.isLoggedIn) {
                if (confirm('ç™»å½•æˆåŠŸï¼æ˜¯å¦ä¿å­˜ç™»å½•çŠ¶æ€åˆ°è°ƒè¯•å·¥å…·ï¼Ÿ')) {
                    authState.isLoggedIn = true;
                    authState.token = result.data.data.token;
                    authState.userId = result.data.data.user_info.user_id;
                    authState.userInfo = result.data.data.user_info;
                    saveAuthState();
                    updateUI();

                    // åŒæ­¥åˆ°é¡¶éƒ¨ç™»å½•è¡¨å•
                    document.getElementById('loginMobile').value = mobile;
                }
            }

            btn.innerHTML = 'æµ‹è¯•ç™»å½•æ¥å£';
        }

        // ============== ç”¨æˆ·æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰ ==============
        async function testGetMyList() {
            if (!authState.isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = event.target;
            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';

            const resolved = document.getElementById('list-resolved').value;
            const page = document.getElementById('list-page').value;
            const limit = document.getElementById('list-limit').value;

            let url = `/api/feedback/list?page=${page}&limit=${limit}`;
            if (resolved !== '') url += `&is_resolved=${resolved}`;

            const result = await sendRequest(url);
            showResult('result-mylist', result.data, !result.ok);

            btn.innerHTML = 'è·å–æˆ‘çš„åé¦ˆåˆ—è¡¨';
        }

        async function testGetDetail() {
            if (!authState.isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = event.target;
            const id = document.getElementById('detail-id').value;

            if (!id) {
                alert('è¯·è¾“å…¥åé¦ˆID');
                return;
            }

            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';
            const result = await sendRequest(`/api/feedback/detail/${id}`);
            showResult('result-detail', result.data, !result.ok);

            btn.innerHTML = 'æŸ¥çœ‹åé¦ˆè¯¦æƒ…';
        }

        async function testSubmit() {
            if (!authState.isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = event.target;
            const type = document.getElementById('submit-type').value;
            const desc = document.getElementById('submit-desc').value.trim();
            const img1 = document.getElementById('submit-img1').value.trim();
            const img2 = document.getElementById('submit-img2').value.trim();
            const img3 = document.getElementById('submit-img3').value.trim();
            const priority = document.getElementById('submit-priority').value;

            if (!desc) {
                alert('è¯·å¡«å†™æè¿°å†…å®¹');
                return;
            }

            btn.innerHTML = 'æäº¤ä¸­<span class="loading"></span>';

            const body = {
                complaint_type: parseInt(type),
                description: desc,
                priority: parseInt(priority)
            };

            if (img1) body.image_url_1 = img1;
            if (img2) body.image_url_2 = img2;
            if (img3) body.image_url_3 = img3;

            const result = await sendRequest('/api/feedback/submit', {
                method: 'POST',
                body: JSON.stringify(body)
            });

            showResult('result-submit', result.data, !result.ok);

            // å¦‚æœæˆåŠŸï¼Œè‡ªåŠ¨å¡«å……IDåˆ°æ›´æ–°å’Œè§£å†³è¡¨å•
            if (result.ok && result.data.data && result.data.data.feedback_id) {
                document.getElementById('update-id').value = result.data.data.feedback_id;
                document.getElementById('resolve-id').value = result.data.data.feedback_id;
            }

            btn.innerHTML = 'æäº¤åé¦ˆ';
        }

        async function testUpdate() {
            if (!authState.isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = event.target;
            const id = document.getElementById('update-id').value;
            const desc = document.getElementById('update-desc').value.trim();
            const priority = document.getElementById('update-priority').value;

            if (!id) {
                alert('è¯·è¾“å…¥åé¦ˆID');
                return;
            }

            btn.innerHTML = 'æ›´æ–°ä¸­<span class="loading"></span>';

            const body = {};
            if (desc) body.description = desc;
            if (priority) body.priority = parseInt(priority);

            const result = await sendRequest(`/api/feedback/update/${id}`, {
                method: 'PUT',
                body: JSON.stringify(body)
            });

            showResult('result-update', result.data, !result.ok);
            btn.innerHTML = 'æ›´æ–°åé¦ˆ';
        }

        // ============== ç®¡ç†å‘˜æ¥å£ ==============
        async function testAdminList() {
            const btn = event.target;
            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';

            const userId = document.getElementById('admin-list-userid').value;
            const type = document.getElementById('admin-list-type').value;
            const resolved = document.getElementById('admin-list-resolved').value;

            let url = '/api/admin/feedback/list?page=1&limit=20';
            if (userId) url += `&user_id=${userId}`;
            if (type) url += `&complaint_type=${type}`;
            if (resolved !== '') url += `&is_resolved=${resolved}`;

            const result = await sendRequest(url, { useAuth: false });
            showResult('result-adminlist', result.data, !result.ok);

            btn.innerHTML = 'è·å–å…¨éƒ¨åé¦ˆåˆ—è¡¨';
        }

        async function testAdminDetail() {
            const btn = event.target;
            const id = document.getElementById('admin-detail-id').value;

            if (!id) {
                alert('è¯·è¾“å…¥åé¦ˆID');
                return;
            }

            btn.innerHTML = 'è¯·æ±‚ä¸­<span class="loading"></span>';
            const result = await sendRequest(`/api/admin/feedback/detail/${id}`, { useAuth: false });
            showResult('result-admindetail', result.data, !result.ok);

            btn.innerHTML = 'æŸ¥çœ‹åé¦ˆè¯¦æƒ…';
        }

        async function testResolve() {
            const btn = event.target;
            const id = document.getElementById('resolve-id').value;
            const content = document.getElementById('resolve-content').value.trim();

            if (!id || !content) {
                alert('è¯·å¡«å†™åé¦ˆIDå’Œå›å¤å†…å®¹');
                return;
            }

            btn.innerHTML = 'å¤„ç†ä¸­<span class="loading"></span>';

            const result = await sendRequest(`/api/admin/feedback/resolve/${id}`, {
                method: 'POST',
                body: JSON.stringify({ feedback_content: content }),
                useAuth: false
            });

            showResult('result-resolve', result.data, !result.ok);
            btn.innerHTML = 'è§£å†³å¹¶å›å¤åé¦ˆ';
        }

        // ============== å·¥å…·å‡½æ•° ==============
        function fillTestData() {
            document.getElementById('test-mobile').value = '13800138000';
            document.getElementById('test-password').value = '123456';
            document.getElementById('loginMobile').value = '13800138000';
            document.getElementById('loginPassword').value = '123456';
            document.getElementById('submit-desc').value = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åé¦ˆï¼Œç”¨äºè°ƒè¯•æ¥å£åŠŸèƒ½ã€‚æè¿°å†…å®¹éœ€è¦è‡³å°‘10ä¸ªå­—ç¬¦ã€‚';
            document.getElementById('submit-img1').value = 'https://example.com/test-image-1.jpg';
            document.getElementById('update-desc').value = 'è¿™æ˜¯æ›´æ–°åçš„æè¿°å†…å®¹ï¼Œç”¨äºæµ‹è¯•æ›´æ–°æ¥å£ã€‚';
            document.getElementById('resolve-content').value = 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œé—®é¢˜å·²ä¿®å¤ï¼Œè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬æŸ¥çœ‹ã€‚';
        }

        function clearAllResults() {
            document.querySelectorAll('.result').forEach(el => {
                el.classList.remove('show');
                el.innerHTML = '';
            });
        }
    </script>
</body>
</html>